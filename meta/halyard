#!/usr/bin/env bash

set -e

ROOT_PATH=/opt/halyard
export GEM_PATH=$ROOT_PATH/vendor
BIN_PATH=$GEM_PATH/bin
REPO_PATH=$ROOT_PATH/repo

FLAGS=''
if [ -n "$DEBUG" ] ; then
    FLAGS="$FLAGS --debug"
fi

if [ -n "$PUPPET_ENV" ] ; then
    FLAGS="$FLAGS --environment='$PUPPET_ENV'"
fi

(
    cd $REPO_PATH
    if [ -n "$(git status -s)" ] ; then
        echo "Repo is unclean: $REPO_PATH"
    else
        git pull &>/dev/null || echo "Failed to update repo: $REPO_PATH"
    fi
)

[[ -e $BIN_PATH/bundle ]] || gem install --no-document --install-dir $GEM_PATH bundler

BUNDLE_CMD="$BIN_PATH/bundle install --path=$GEM_PATH --binstubs=$BIN_PATH --gemfile=$REPO_PATH/Gemfile --without=development"

$BUNDLE_CMD &>/dev/null || echo "Failed to run: $BUNDLE_CMD"

(cd $REPO_PATH && $BIN_PATH/librarian-puppet install --path=modules)

sudo $BIN_PATH/puppet apply --confdir=$REPO_PATH $FLAGS
